# Diagramas de Arquitectura - Payment Observability System

## ğŸ“Š Diagramas Visuales del Sistema

Esta documentaciÃ³n contiene diagramas ASCII y descripciones visuales para entender el sistema.

---

## 1. Arquitectura de Capas Detallada

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT LAYER                                â”‚
â”‚  â€¢ Frontend Dashboard (React/Next.js)                               â”‚
â”‚  â€¢ API Clients (Postman, cURL)                                      â”‚
â”‚  â€¢ External Systems (Payment Providers)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP/REST
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API LAYER (FastAPI)                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ â”‚   Events     â”‚  â”‚  Analytics   â”‚  â”‚    Health    â”‚               â”‚
â”‚ â”‚   Router     â”‚  â”‚   Router     â”‚  â”‚    Router    â”‚               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚        â”‚                 â”‚                   â”‚                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ â”‚         Middleware Layer                          â”‚               â”‚
â”‚ â”‚  â€¢ CORS         â€¢ Rate Limiting                   â”‚               â”‚
â”‚ â”‚  â€¢ Error Handler  â€¢ Request Validation            â”‚               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              APPLICATION SERVICES LAYER                             â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         IngestionOrchestrator (Coordinator)                  â”‚  â”‚
â”‚  â”‚  â€¢ Selecciona estrategia de normalizaciÃ³n                    â”‚  â”‚
â”‚  â”‚  â€¢ Coordina flujo completo                                   â”‚  â”‚
â”‚  â”‚  â€¢ Maneja errores â†’ UNPROCESSED                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                 â”‚                  â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ AIBasedNormalizerâ”‚ â”‚ RuleNormalizerâ”‚ â”‚ EventProcessor  â”‚         â”‚
â”‚  â”‚ (LangChain)      â”‚ â”‚ (Stripe,Adyen)â”‚ â”‚ (Validaciones)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         AnalyticsService                                     â”‚  â”‚
â”‚  â”‚  â€¢ MÃ©tricas agregadas                                        â”‚  â”‚
â”‚  â”‚  â€¢ Dashboards                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOMAIN LAYER                                     â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Domain Models (Entities)                                    â”‚  â”‚
â”‚  â”‚  â€¢ NormalizedPaymentEvent (SQLModel)                         â”‚  â”‚
â”‚  â”‚  â€¢ PaymentStatus, FailureReason (Enums)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Interfaces (Contracts/Protocols)                            â”‚  â”‚
â”‚  â”‚  â€¢ INormalizer                                               â”‚  â”‚
â”‚  â”‚  â€¢ IPaymentRepository                                        â”‚  â”‚
â”‚  â”‚  â€¢ IEventProcessor                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Business Logic (Normalizers)                                â”‚  â”‚
â”‚  â”‚  â€¢ Rule-based mappings                                       â”‚  â”‚
â”‚  â”‚  â€¢ Validation rules                                          â”‚  â”‚
â”‚  â”‚  â€¢ Failure reason catalog                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               INFRASTRUCTURE LAYER                                  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Database      â”‚  â”‚   AI Services   â”‚  â”‚  Configuration  â”‚    â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚    â”‚
â”‚  â”‚  â€¢ AsyncEngine  â”‚  â”‚  â€¢ LangChain    â”‚  â”‚  â€¢ Settings     â”‚    â”‚
â”‚  â”‚  â€¢ AsyncSession â”‚  â”‚  â€¢ ChatOpenAI   â”‚  â”‚  â€¢ Env Vars     â”‚    â”‚
â”‚  â”‚  â€¢ Repository   â”‚  â”‚  â€¢ Prompts      â”‚  â”‚  â€¢ Logging      â”‚    â”‚
â”‚  â”‚    Impl         â”‚  â”‚  â€¢ Retry Logic  â”‚  â”‚                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                    â”‚                     â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              External Integrations                         â”‚   â”‚
â”‚  â”‚  â€¢ PostgreSQL (psycopg async)                              â”‚   â”‚
â”‚  â”‚  â€¢ OpenAI API                                              â”‚   â”‚
â”‚  â”‚  â€¢ S3 (opcional - backups)                                 â”‚   â”‚
â”‚  â”‚  â€¢ Kafka (opcional - event streaming)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Flujo de Datos - Happy Path (Detallado)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚  POST /events
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  { "raw_event": {...}, "provider": "stripe" }
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. API Router (events.py)                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ â€¢ Pydantic validation (EventIngestRequest)           â”‚  â”‚
â”‚     â”‚ â€¢ Rate limiting check (SlowAPI: 10 req/min)          â”‚  â”‚
â”‚     â”‚ â€¢ Extract raw_event + provider hint                  â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ EventIngestRequest
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. IngestionOrchestrator.ingest(raw_event)                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ DecisiÃ³n: Â¿QuÃ© normalizador usar?                    â”‚  â”‚
â”‚     â”‚                                                       â”‚  â”‚
â”‚     â”‚ if provider == "stripe" AND known_format:            â”‚  â”‚
â”‚     â”‚     â†’ RuleBasedNormalizer                            â”‚  â”‚
â”‚     â”‚ elif provider == "adyen" AND known_format:           â”‚  â”‚
â”‚     â”‚     â†’ RuleBasedNormalizer                            â”‚  â”‚
â”‚     â”‚ else:                                                â”‚  â”‚
â”‚     â”‚     â†’ AIBasedNormalizer (LangChain)                  â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                 â”‚
     â–¼ (Known)         â–¼ (Unknown)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RuleNormalizer â”‚  â”‚ AIBasedNormalizer                        â”‚
â”‚                â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Mapeo directo: â”‚  â”‚  â”‚ 1. Prepare prompt:                â”‚  â”‚
â”‚  stripe.status â”‚  â”‚  â”‚    - System: Expert instructions  â”‚  â”‚
â”‚  -> PaymentStatâ”‚  â”‚  â”‚    - User: raw_event JSON        â”‚  â”‚
â”‚                â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚ Latencia: <5ms â”‚  â”‚  â”‚ 2. ChatOpenAI.with_structured_out â”‚  â”‚
â”‚                â”‚  â”‚  â”‚    - Model: gpt-4o-mini           â”‚  â”‚
â”‚                â”‚  â”‚  â”‚    - Temperature: 0.0             â”‚  â”‚
â”‚                â”‚  â”‚  â”‚    - Timeout: 10s                 â”‚  â”‚
â”‚                â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚                â”‚  â”‚  â”‚ 3. Retry on failure:              â”‚  â”‚
â”‚                â”‚  â”‚  â”‚    - Max 3 attempts               â”‚  â”‚
â”‚                â”‚  â”‚  â”‚    - Exponential backoff          â”‚  â”‚
â”‚                â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚                â”‚  â”‚  â”‚ 4. Parse response â†’               â”‚  â”‚
â”‚                â”‚  â”‚  â”‚    NormalizedPaymentSchema        â”‚  â”‚
â”‚                â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                â”‚  â”‚ Latencia: ~1-2s                          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ NormalizedPaymentSchema (Pydantic)
                â”‚ {
                â”‚   merchant_name: "Acme Corp",
                â”‚   provider: "stripe",
                â”‚   country: "US",
                â”‚   status_category: "APPROVED",
                â”‚   amount_usd: 50.00,
                â”‚   ...
                â”‚ }
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. EventProcessor.validate(normalized_data)                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ Business validations:                                â”‚  â”‚
â”‚     â”‚  âœ“ country is ISO 3166-1 alpha-2 (2 chars)          â”‚  â”‚
â”‚     â”‚  âœ“ amount_usd > 0                                    â”‚  â”‚
â”‚     â”‚  âœ“ status_category in allowed values                â”‚  â”‚
â”‚     â”‚  âœ“ failure_reason maps to catalog                   â”‚  â”‚
â”‚     â”‚                                                       â”‚  â”‚
â”‚     â”‚ If validation fails:                                 â”‚  â”‚
â”‚     â”‚   â†’ raise ValidationException                        â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ Valid âœ“
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Convert to SQLModel                                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ event = NormalizedPaymentEvent(                      â”‚  â”‚
â”‚     â”‚     **normalized_schema.model_dump(),                â”‚  â”‚
â”‚     â”‚     raw_data=raw_event,  # Preserve original         â”‚  â”‚
â”‚     â”‚     created_at=datetime.utcnow(),                    â”‚  â”‚
â”‚     â”‚     normalized_at=datetime.utcnow(),                 â”‚  â”‚
â”‚     â”‚     normalization_method="AI" | "RULE_BASED"         â”‚  â”‚
â”‚     â”‚ )                                                     â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ NormalizedPaymentEvent (SQLModel)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. PaymentRepository.save(event)                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ async with AsyncSession:                             â”‚  â”‚
â”‚     â”‚     session.add(event)                               â”‚  â”‚
â”‚     â”‚     await session.commit()                           â”‚  â”‚
â”‚     â”‚     await session.refresh(event)                     â”‚  â”‚
â”‚     â”‚                                                       â”‚  â”‚
â”‚     â”‚ SQL generated:                                        â”‚  â”‚
â”‚     â”‚ INSERT INTO normalized_payment_events                â”‚  â”‚
â”‚     â”‚   (id, merchant_name, provider, ...)                 â”‚  â”‚
â”‚     â”‚ VALUES ($1, $2, $3, ...)                             â”‚  â”‚
â”‚     â”‚ RETURNING *                                          â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ Saved event (with id generated)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Logging & Metrics                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ logger.info("event_ingested", extra={                â”‚  â”‚
â”‚     â”‚     "event_id": str(event.id),                       â”‚  â”‚
â”‚     â”‚     "provider": event.provider,                      â”‚  â”‚
â”‚     â”‚     "status": event.status_category,                 â”‚  â”‚
â”‚     â”‚     "method": event.normalization_method,            â”‚  â”‚
â”‚     â”‚     "latency_ms": processing_time                    â”‚  â”‚
â”‚     â”‚ })                                                    â”‚  â”‚
â”‚     â”‚                                                       â”‚  â”‚
â”‚     â”‚ # Prometheus metrics (futuro)                        â”‚  â”‚
â”‚     â”‚ payment_events_total.labels(                         â”‚  â”‚
â”‚     â”‚     provider=event.provider,                         â”‚  â”‚
â”‚     â”‚     status=event.status                              â”‚  â”‚
â”‚     â”‚ ).inc()                                              â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. API Response                                               â”‚
â”‚     EventIngestResponse {                                      â”‚
â”‚         "id": "550e8400-e29b-41d4-a716-446655440000",         â”‚
â”‚         "status": "APPROVED",                                 â”‚
â”‚         "normalization_method": "AI",                         â”‚
â”‚         "confidence_score": 0.95,                             â”‚
â”‚         "message": "Event ingested successfully"              â”‚
â”‚     }                                                          â”‚
â”‚     Status Code: 201 CREATED                                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚  Receives response
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**MÃ©tricas del flujo:**

- **Total latency**: 1-2s (con AI), <100ms (con rules)
- **Database commits**: 1
- **API calls**: 1 (OpenAI, solo si usa AI)
- **Logs generados**: 3-4 (info level)

---

## 3. Flujo de Error - Resilience Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚  POST /events
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  { "raw_event": {...} }  â† Formato invÃ¡lido/desconocido
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Router                                â”‚
â”‚  âœ“ Pydantic validation passes              â”‚
â”‚    (raw_event es dict, no vacÃ­o)           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IngestionOrchestrator                     â”‚
â”‚  Selecciona: AIBasedNormalizer             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIBasedNormalizer.normalize()             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ TRY:                                 â”‚  â”‚
â”‚  â”‚   await llm.ainvoke(...)             â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚ CATCH RateLimitError:                â”‚  â”‚
â”‚  â”‚   âŒ OpenAI rate limit hit           â”‚  â”‚
â”‚  â”‚   â†’ raise AIServiceException         â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚ CATCH APITimeoutError:               â”‚  â”‚
â”‚  â”‚   âŒ Request took > 10s              â”‚  â”‚
â”‚  â”‚   â†’ retry (attempt 2/3)              â”‚  â”‚
â”‚  â”‚   â†’ still fails                      â”‚  â”‚
â”‚  â”‚   â†’ raise AIServiceException         â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚ CATCH ValidationError:               â”‚  â”‚
â”‚  â”‚   âŒ LLM returned invalid JSON       â”‚  â”‚
â”‚  â”‚   â†’ raise AIServiceException         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ AIServiceException raised
     â”‚ "AI normalization failed: Timeout"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IngestionOrchestrator.ingest()            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ CATCH AIServiceException:            â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚   logger.warning(                    â”‚  â”‚
â”‚  â”‚     "normalization_failed",          â”‚  â”‚
â”‚  â”‚     exc_info=True                    â”‚  â”‚
â”‚  â”‚   )                                  â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚   # RESILIENCE: No perder el evento  â”‚  â”‚
â”‚  â”‚   return await self._save_as_        â”‚  â”‚
â”‚  â”‚            unprocessed(              â”‚  â”‚
â”‚  â”‚       raw_event,                     â”‚  â”‚
â”‚  â”‚       error_msg=str(exc)             â”‚  â”‚
â”‚  â”‚   )                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  _save_as_unprocessed()                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ event = NormalizedPaymentEvent(                    â”‚    â”‚
â”‚  â”‚     id=uuid4(),                                    â”‚    â”‚
â”‚  â”‚     status_category="UNPROCESSED",  â† Special flag â”‚    â”‚
â”‚  â”‚     merchant_name="UNKNOWN",                       â”‚    â”‚
â”‚  â”‚     provider="UNKNOWN",                            â”‚    â”‚
â”‚  â”‚     country="XX",                                  â”‚    â”‚
â”‚  â”‚     amount_usd=0.0,                                â”‚    â”‚
â”‚  â”‚     raw_data=raw_event,  â† PRESERVE ORIGINAL!     â”‚    â”‚
â”‚  â”‚     validation_errors=[                            â”‚    â”‚
â”‚  â”‚         "AI normalization failed: Timeout"         â”‚    â”‚
â”‚  â”‚     ],                                             â”‚    â”‚
â”‚  â”‚     normalization_method="MANUAL",  â† Needs human â”‚    â”‚
â”‚  â”‚     created_at=datetime.utcnow()                   â”‚    â”‚
â”‚  â”‚ )                                                  â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚ return await repository.save(event)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ Event guardado como UNPROCESSED
     â”‚ âœ“ No se perdiÃ³ data
     â”‚ âœ“ raw_data preservado
     â”‚ âœ“ Error logged
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Database                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ normalized_payment_events            â”‚  â”‚
â”‚  â”‚                                      â”‚  â”‚
â”‚  â”‚ id: 123-456-789                      â”‚  â”‚
â”‚  â”‚ status_category: "UNPROCESSED"       â”‚  â”‚
â”‚  â”‚ validation_errors: [...]             â”‚  â”‚
â”‚  â”‚ raw_data: {original_event}           â”‚  â”‚
â”‚  â”‚ created_at: 2025-12-13 10:30:00      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ â° Wait for background worker...
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Background Worker (Cron: cada 5 min)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Query UNPROCESSED events:                       â”‚  â”‚
â”‚  â”‚    SELECT * FROM normalized_payment_events         â”‚  â”‚
â”‚  â”‚    WHERE status_category = 'UNPROCESSED'           â”‚  â”‚
â”‚  â”‚    AND retry_count < 3                             â”‚  â”‚
â”‚  â”‚    LIMIT 100                                       â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚ 2. For each event:                                 â”‚  â”‚
â”‚  â”‚    try:                                            â”‚  â”‚
â”‚  â”‚      normalized = await normalizer.normalize(      â”‚  â”‚
â”‚  â”‚          event.raw_data                            â”‚  â”‚
â”‚  â”‚      )                                             â”‚  â”‚
â”‚  â”‚      # Update event with normalized data           â”‚  â”‚
â”‚  â”‚      event.status_category = normalized.status     â”‚  â”‚
â”‚  â”‚      event.merchant_name = normalized.merchant     â”‚  â”‚
â”‚  â”‚      # ...                                         â”‚  â”‚
â”‚  â”‚      await repo.update(event)                      â”‚  â”‚
â”‚  â”‚      âœ“ Success!                                    â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚    except AIServiceException:                      â”‚  â”‚
â”‚  â”‚      event.retry_count += 1                        â”‚  â”‚
â”‚  â”‚      if event.retry_count >= 3:                    â”‚  â”‚
â”‚  â”‚        # Move to Dead Letter Queue                 â”‚  â”‚
â”‚  â”‚        event.status_category = "DLQ"               â”‚  â”‚
â”‚  â”‚      await repo.update(event)                      â”‚  â”‚
â”‚  â”‚                                                     â”‚  â”‚
â”‚  â”‚ 3. Log summary:                                    â”‚  â”‚
â”‚  â”‚    logger.info("retry_worker_completed", extra={   â”‚  â”‚
â”‚  â”‚        "processed": 10,                            â”‚  â”‚
â”‚  â”‚        "succeeded": 7,                             â”‚  â”‚
â”‚  â”‚        "failed": 3                                 â”‚  â”‚
â”‚  â”‚    })                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ventajas de este patrÃ³n:**

1. âœ… **No se pierde data** - Siempre se guarda raw_data
2. âœ… **Auditable** - Sabemos por quÃ© fallÃ³
3. âœ… **Recoverable** - Worker puede reintentar
4. âœ… **Traceable** - Logs completos del error
5. âœ… **DLQ pattern** - DespuÃ©s de 3 intentos â†’ Dead Letter Queue

---

## 4. Database Schema Detallado

```sql
-- Tabla principal
CREATE TABLE normalized_payment_events (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Business Fields (Indexed para queries rÃ¡pidas)
    merchant_name VARCHAR(255) NOT NULL,
    provider VARCHAR(100) NOT NULL,
    country CHAR(2) NOT NULL,  -- ISO 3166-1 alpha-2

    -- Normalized Status
    status_category VARCHAR(50) NOT NULL,  -- APPROVED, FAILED, ERROR, PENDING, UNPROCESSED
    failure_reason VARCHAR(100),  -- CatÃ¡logo estandarizado

    -- Metrics
    amount_usd DECIMAL(19, 4) NOT NULL,  -- Siempre en USD
    latency_ms INTEGER,  -- Tiempo de respuesta del provider

    -- Audit Fields
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    normalized_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    normalization_method VARCHAR(50) NOT NULL,  -- AI, RULE_BASED, HYBRID, MANUAL

    -- Flexible Data (JSONB para queries eficientes)
    raw_data JSONB NOT NULL DEFAULT '{}',  -- Evento original preservado
    metadata JSONB NOT NULL DEFAULT '{}',  -- Extra: fees, customer_id, etc.

    -- Quality Metrics
    confidence_score DECIMAL(3, 2),  -- 0.00 - 1.00 (confianza de la IA)
    validation_errors JSONB,  -- Array de errores si los hay

    -- Retry Logic (para worker)
    retry_count INTEGER DEFAULT 0,
    last_retry_at TIMESTAMP WITH TIME ZONE
);

-- Ãndices para Performance
CREATE INDEX idx_created_at
    ON normalized_payment_events(created_at DESC);

CREATE INDEX idx_status_category
    ON normalized_payment_events(status_category);

CREATE INDEX idx_provider
    ON normalized_payment_events(provider);

CREATE INDEX idx_merchant_name
    ON normalized_payment_events(merchant_name);

CREATE INDEX idx_country
    ON normalized_payment_events(country);

-- Ãndice compuesto para analytics (queries comunes)
CREATE INDEX idx_analytics
    ON normalized_payment_events(
        provider,
        status_category,
        created_at DESC
    );

-- Ãndice compuesto para merchant analytics
CREATE INDEX idx_merchant_analytics
    ON normalized_payment_events(
        merchant_name,
        country,
        created_at DESC
    );

-- Ãndice para JSONB queries
CREATE INDEX idx_raw_data_provider
    ON normalized_payment_events
    USING gin ((raw_data -> 'provider'));

-- Ãndice para worker queries
CREATE INDEX idx_unprocessed
    ON normalized_payment_events(status_category, retry_count)
    WHERE status_category = 'UNPROCESSED';

-- Partial index para eventos fallidos
CREATE INDEX idx_failed_events
    ON normalized_payment_events(failure_reason, created_at DESC)
    WHERE status_category = 'FAILED';
```

### Queries Comunes Optimizadas

```sql
-- 1. Get evento por ID (Primary Key lookup - O(1))
SELECT * FROM normalized_payment_events WHERE id = $1;

-- 2. Analytics: Total por provider y status (usa idx_analytics)
SELECT
    provider,
    status_category,
    COUNT(*) as total,
    SUM(amount_usd) as total_amount,
    AVG(latency_ms) as avg_latency
FROM normalized_payment_events
WHERE created_at >= $1 AND created_at <= $2
GROUP BY provider, status_category;

-- 3. Top failure reasons (usa idx_failed_events)
SELECT
    failure_reason,
    COUNT(*) as occurrences,
    AVG(amount_usd) as avg_failed_amount
FROM normalized_payment_events
WHERE status_category = 'FAILED'
    AND created_at >= NOW() - INTERVAL '7 days'
GROUP BY failure_reason
ORDER BY occurrences DESC
LIMIT 10;

-- 4. Worker: Get unprocessed events (usa idx_unprocessed)
SELECT * FROM normalized_payment_events
WHERE status_category = 'UNPROCESSED'
    AND retry_count < 3
ORDER BY created_at ASC
LIMIT 100;

-- 5. Merchant analytics (usa idx_merchant_analytics)
SELECT
    merchant_name,
    country,
    COUNT(*) as total_transactions,
    COUNT(*) FILTER (WHERE status_category = 'APPROVED') as approved,
    COUNT(*) FILTER (WHERE status_category = 'FAILED') as failed,
    ROUND(
        COUNT(*) FILTER (WHERE status_category = 'APPROVED')::numeric /
        NULLIF(COUNT(*), 0) * 100,
        2
    ) as approval_rate
FROM normalized_payment_events
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY merchant_name, country
ORDER BY total_transactions DESC;

-- 6. JSONB query: Events de un provider especÃ­fico en raw_data
SELECT
    id,
    merchant_name,
    status_category,
    raw_data
FROM normalized_payment_events
WHERE raw_data->>'provider' = 'custom_gateway'
    AND created_at >= NOW() - INTERVAL '1 day';
```

---

## 5. Dependency Injection Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI Request                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  @router.post("/events")                                   â”‚
â”‚  async def ingest_event(                                   â”‚
â”‚      request: EventIngestRequest,  â† Pydantic validation   â”‚
â”‚      session: AsyncSessionDep,     â† Dependency 1          â”‚
â”‚      orchestrator: Annotated[                              â”‚
â”‚          IngestionOrchestrator,                            â”‚
â”‚          Depends(get_orchestrator) â† Dependency 2          â”‚
â”‚      ]                                                     â”‚
â”‚  ):                                                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ FastAPI DI Container resuelve dependencias:
     â”‚
     â”œâ”€â”€â”€ get_async_session() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                  â”‚
     â””â”€â”€â”€ get_orchestrator() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚                        â”‚
              â”œâ”€â”€â”€ get_ai_normalizer() â”‚
              â”‚        â”‚                â”‚
              â”‚        â””â”€â”€â”€ get_langchain_client()
              â”‚                         â”‚
              â”œâ”€â”€â”€ get_rule_normalizer()â”‚
              â”‚                         â”‚
              â””â”€â”€â”€ get_repository() â”€â”€â”€â”€â”˜
                       â”‚
                       â””â”€â”€â”€ get_async_session()  â† Reused!
```

### Grafo de Dependencias Completo

```
EventIngestRequest
        â”‚
        â”œâ”€â”€â”€ AsyncSession (Singleton per request)
        â”‚         â”‚
        â”‚         â””â”€â”€â”€ AsyncEngine (Singleton global)
        â”‚
        â””â”€â”€â”€ IngestionOrchestrator
                  â”‚
                  â”œâ”€â”€â”€ AIBasedNormalizer
                  â”‚         â”‚
                  â”‚         â””â”€â”€â”€ LangChainClient
                  â”‚                   â”‚
                  â”‚                   â”œâ”€â”€â”€ ChatOpenAI
                  â”‚                   â””â”€â”€â”€ Settings
                  â”‚
                  â”œâ”€â”€â”€ RuleBasedNormalizer
                  â”‚         â”‚
                  â”‚         â””â”€â”€â”€ ProviderMappings
                  â”‚
                  â”œâ”€â”€â”€ EventProcessor
                  â”‚         â”‚
                  â”‚         â””â”€â”€â”€ ValidationRules
                  â”‚
                  â””â”€â”€â”€ PaymentRepository
                            â”‚
                            â””â”€â”€â”€ AsyncSession (shared â†‘)
```

**Ventajas de este diseÃ±o:**

- âœ… **Testeable**: FÃ¡cil mockear dependencias
- âœ… **Reusable**: AsyncSession compartida en request
- âœ… **Mantenible**: Cambiar implementaciÃ³n sin tocar endpoints
- âœ… **Type-safe**: Type hints verificados en compile-time

---

## 6. State Transitions (Payment Status)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Payment Event Lifecycle                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input Event
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UNPROCESSED â”‚ â† Evento que fallÃ³ normalizaciÃ³n
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Retry Worker Success
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚              â”‚             â”‚
       â–¼               â–¼              â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APPROVED â”‚    â”‚  FAILED  â”‚   â”‚  ERROR  â”‚   â”‚ PENDING â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   Final           Final         Final       Transitional

APPROVED:
  - TransacciÃ³n exitosa
  - Payment processed
  - Money transferred

FAILED:
  - Rechazado por banco
  - Insufficient funds
  - Card declined
  - Business rules violated

ERROR:
  - Error tÃ©cnico
  - Provider timeout
  - Network error
  - System exception

PENDING:
  - En proceso
  - Waiting for 3DS
  - Async confirmation

UNPROCESSED:
  - No se pudo normalizar
  - Waiting for retry
  - Manual review needed
```

---

## 7. AI Normalization Decision Tree

```
Input: raw_event
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Provider hint present? â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ YES â”€â”€â”€â”€â”
     â”‚            â”‚
     â”‚            â–¼
     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚    â”‚ Provider in          â”‚
     â”‚    â”‚ SUPPORTED_PROVIDERS? â”‚
     â”‚    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚
     â”‚       â”œâ”€â”€â”€ YES (stripe, adyen, etc.)
     â”‚       â”‚    â”‚
     â”‚       â”‚    â–¼
     â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚  â”‚ Format matches     â”‚
     â”‚       â”‚  â”‚ expected schema?   â”‚
     â”‚       â”‚  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚     â”‚
     â”‚       â”‚     â”œâ”€â”€â”€ YES
     â”‚       â”‚     â”‚    â”‚
     â”‚       â”‚     â”‚    â–¼
     â”‚       â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚     â”‚  â”‚ RuleNormalizer   â”‚
     â”‚       â”‚     â”‚  â”‚ â€¢ Fast (<5ms)    â”‚
     â”‚       â”‚     â”‚  â”‚ â€¢ Deterministic  â”‚
     â”‚       â”‚     â”‚  â”‚ â€¢ Free           â”‚
     â”‚       â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚     â”‚
     â”‚       â”‚     â””â”€â”€â”€ NO
     â”‚       â”‚          â”‚
     â”‚       â”‚          â–¼
     â”‚       â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚        â”‚ Partial match?   â”‚
     â”‚       â”‚        â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚           â”‚
     â”‚       â”‚           â”œâ”€â”€â”€ YES
     â”‚       â”‚           â”‚    â”‚
     â”‚       â”‚           â”‚    â–¼
     â”‚       â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚       â”‚           â”‚  â”‚ HybridNormalizer â”‚
     â”‚       â”‚           â”‚  â”‚ â€¢ Rules first    â”‚
     â”‚       â”‚           â”‚  â”‚ â€¢ AI for gaps    â”‚
     â”‚       â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚       â”‚           â”‚
     â”‚       â”‚           â””â”€â”€â”€ NO
     â”‚       â”‚                â”‚
     â”‚       â””â”€â”€â”€ NO           â”‚
     â”‚            â”‚            â”‚
     â””â”€â”€â”€ NO â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ AIBasedNormalizerâ”‚
            â”‚ â€¢ Slow (~1-2s)   â”‚
            â”‚ â€¢ Flexible       â”‚
            â”‚ â€¢ Costs tokens   â”‚
            â”‚ â€¢ confidence_scoreâ”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Data Lake Integration Architecture ğŸŒŠ

### OpciÃ³n 1: Polling Worker (Hackathon) â­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   S3 Data Lake                           â”‚
â”‚                                                          â”‚
â”‚   s3://yuno-payments-lake/                              â”‚
â”‚   â””â”€â”€ raw-payments/                                     â”‚
â”‚       â”œâ”€â”€ 2024-12-13/                                   â”‚
â”‚       â”‚   â”œâ”€â”€ transactions_001.json      â† NEW          â”‚
â”‚       â”‚   â”œâ”€â”€ transactions_002.jsonl     â† NEW          â”‚
â”‚       â”‚   â””â”€â”€ transactions_003.csv       â† NEW          â”‚
â”‚       â””â”€â”€ 2024-12-14/                                   â”‚
â”‚           â””â”€â”€ transactions_004.parquet                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ â° Polling 2 veces al dÃ­a (cada 12h)
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Data Lake Poller Worker                â”‚
            â”‚                                          â”‚
            â”‚  1ï¸âƒ£  List files in S3 bucket            â”‚
            â”‚      (boto3.list_objects_v2)            â”‚
            â”‚                                          â”‚
            â”‚  2ï¸âƒ£  Filter processed files             â”‚
            â”‚      (check ProcessedFile table)        â”‚
            â”‚                                          â”‚
            â”‚  3ï¸âƒ£  Download new files                 â”‚
            â”‚      (boto3.get_object)                 â”‚
            â”‚                                          â”‚
            â”‚  4ï¸âƒ£  Parse by format                    â”‚
            â”‚      â€¢ JSON     â†’ json.loads            â”‚
            â”‚      â€¢ JSONL    â†’ line-by-line          â”‚
            â”‚      â€¢ CSV      â†’ pandas.read_csv       â”‚
            â”‚      â€¢ Parquet  â†’ pandas.read_parquet   â”‚
            â”‚                                          â”‚
            â”‚  5ï¸âƒ£  Send to ingestion (batches of 50)  â”‚
            â”‚                                          â”‚
            â”‚  6ï¸âƒ£  Mark as processed in DB            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ POST /api/v1/events (batch)
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     Payment Observability System         â”‚
            â”‚                                          â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚  IngestionOrchestrator             â”‚  â”‚
            â”‚  â”‚  â€¢ Receives batch of transactions  â”‚  â”‚
            â”‚  â”‚  â€¢ Normalizes each (Rules + AI)    â”‚  â”‚
            â”‚  â”‚  â€¢ Stores in PostgreSQL            â”‚  â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚          PostgreSQL                      â”‚
            â”‚                                          â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚ normalized_payment_events          â”‚  â”‚
            â”‚  â”‚ â€¢ transaction_id                   â”‚  â”‚
            â”‚  â”‚ â€¢ amount, currency                 â”‚  â”‚
            â”‚  â”‚ â€¢ status, provider                 â”‚  â”‚
            â”‚  â”‚ â€¢ raw_event (JSONB)                â”‚  â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â”‚                                          â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚ processed_files                    â”‚  â”‚
            â”‚  â”‚ â€¢ file_path (unique)               â”‚  â”‚
            â”‚  â”‚ â€¢ processing_status                â”‚  â”‚
            â”‚  â”‚ â€¢ records_count                    â”‚  â”‚
            â”‚  â”‚ â€¢ started_at, completed_at         â”‚  â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpciÃ³n 2: Event-Driven (ProducciÃ³n)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   S3 Data Lake                           â”‚
â”‚                                                          â”‚
â”‚   Event: s3:ObjectCreated:*                             â”‚
â”‚   Filter: prefix=raw-payments/                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Event notification (< 1s)
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚         SNS Topic                        â”‚
            â”‚   yuno-payment-file-created             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Fan-out
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚         SQS Queue                        â”‚
            â”‚   yuno-payment-processing-queue         â”‚
            â”‚                                          â”‚
            â”‚   â€¢ Visibility timeout: 5 min           â”‚
            â”‚   â€¢ Max receives: 3                     â”‚
            â”‚   â€¢ DLQ: yuno-payment-dlq               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Long polling (20s)
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    SQS Consumer Worker                   â”‚
            â”‚                                          â”‚
            â”‚  while True:                            â”‚
            â”‚    messages = sqs.receive_message()    â”‚
            â”‚                                          â”‚
            â”‚    for msg in messages:                â”‚
            â”‚      process_s3_event(msg)             â”‚
            â”‚      sqs.delete_message(msg)           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Process immediately
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Same flow as Polling Worker             â”‚
            â”‚  (download â†’ parse â†’ ingest â†’ track)     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpciÃ³n 3: Kafka Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   S3 Data Lake                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ S3 Event or Polling
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Lambda / Worker                        â”‚
            â”‚   (File Detector)                        â”‚
            â”‚                                          â”‚
            â”‚   â€¢ Detects new file                    â”‚
            â”‚   â€¢ Creates event payload               â”‚
            â”‚   â€¢ Publishes to Kafka                  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Kafka Message
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      Kafka Topic                         â”‚
            â”‚      payment-files-topic                 â”‚
            â”‚                                          â”‚
            â”‚   Partition by: hash(file_path)         â”‚
            â”‚   Retention: 7 days                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ Consumer group
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Kafka Consumer Worker                  â”‚
            â”‚   (existing app/infraestructure/kafka/)  â”‚
            â”‚                                          â”‚
            â”‚   â€¢ Consumes file event                 â”‚
            â”‚   â€¢ Downloads from S3                   â”‚
            â”‚   â€¢ Processes transactions              â”‚
            â”‚   â€¢ Commits offset                      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Lake File Formats Support

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supported File Formats                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  JSON (.json)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ [                                          â”‚
    â”‚   {"transaction_id": "tx1", ...},          â”‚
    â”‚   {"transaction_id": "tx2", ...}           â”‚
    â”‚ ]                                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    Parser: json.loads() â†’ list

2ï¸âƒ£  JSON Lines (.jsonl)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ {"transaction_id": "tx1", ...}             â”‚
    â”‚ {"transaction_id": "tx2", ...}             â”‚
    â”‚ {"transaction_id": "tx3", ...}             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    Parser: Split by \n â†’ json.loads each line

3ï¸âƒ£  CSV (.csv)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ transaction_id,amount,currency,status      â”‚
    â”‚ tx1,100.50,USD,approved                    â”‚
    â”‚ tx2,250.00,EUR,declined                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    Parser: pandas.read_csv() â†’ to_dict('records')

4ï¸âƒ£  Parquet (.parquet)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ [Binary columnar format]                   â”‚
    â”‚ â€¢ Compressed                               â”‚
    â”‚ â€¢ Schema embedded                          â”‚
    â”‚ â€¢ Fast queries                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    Parser: pandas.read_parquet() â†’ to_dict('records')
```

### Tracking de Archivos Procesados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            processed_files Table                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  id (PK)                     | 1                         â”‚
â”‚  file_path (UNIQUE)          | s3://bucket/file.json     â”‚
â”‚  bucket_name                 | yuno-payments-lake        â”‚
â”‚  object_key                  | raw/2024-12-13/file.json  â”‚
â”‚  file_size                   | 245680 bytes              â”‚
â”‚  records_count               | 150                       â”‚
â”‚  processing_status           | completed                 â”‚
â”‚  error_message               | NULL                      â”‚
â”‚  started_at                  | 2024-12-13 10:30:00       â”‚
â”‚  completed_at                | 2024-12-13 10:30:15       â”‚
â”‚  last_modified (S3)          | 2024-12-13 10:25:00       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

States:
â€¢ pending     â†’ File detected, not started
â€¢ processing  â†’ Currently being processed
â€¢ completed   â†’ Successfully processed
â€¢ failed      â†’ Error occurred (see error_message)

Idempotency:
âœ… Same file won't be processed twice (UNIQUE constraint)
âœ… Can retry failed files (update status to pending)
âœ… Audit trail of all processed files
```

---

**Fin de Diagramas** ğŸ“Š
